name: Validate Changed SQL Files

on:
  push:
    paths:
      - '**/*.sql'
  pull_request:
    paths:
      - '**/*.sql'

jobs:
  validate-sql:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install PostgreSQL client
        run: sudo apt-get install -y postgresql-client

      - name: Run Changed SQL Files
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_NAME: ${{ secrets.DB_NAME }}
        run: |
          set -e  # stop immediately on any error
          export PGPASSWORD=$DB_PASSWORD

          # Get only the SQL files changed in this push or pull request
          CHANGED_FILES=$(git diff --name-only origin/main | grep '.sql$' || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "✅ No SQL files changed. Skipping."
            exit 0
          fi

          echo "Changed SQL files:"
          echo "$CHANGED_FILES"

          for file in $CHANGED_FILES; do
            echo "▶️ Running $file..."
            psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -d "$DB_NAME" -f "$file"
          done
